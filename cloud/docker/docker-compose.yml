services:
  cloud-mysql:
    container_name: cloud-mysql
    image: mysql:8.0
    build:
      context: ./mysql
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/conf:/etc/mysql/conf.d
      - ./mysql/logs:/logs
      - ./mysql/data:/var/lib/mysql
       # 挂载初始化脚本
      - ./mysql/init:/docker-entrypoint-initdb.d
    command: [
      'mysqld',
      '--default-authentication-plugin=mysql_native_password',
      '--innodb-buffer-pool-size=80M',
      '--character-set-server=utf8mb4',
      '--collation-server=utf8mb4_unicode_ci',
      '--default-time-zone=+8:00',
      '--lower-case-table-names=1'
    ]
    environment:
      MYSQL_ROOT_PASSWORD: root
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]   # 为 MySQL 添加健康检查，确保 eureka 启动时 MySQL 已就绪
      interval: 10s  # 每10秒检查一次
      timeout: 5s    # 超时5秒
      retries: 10    # 重试10次
    networks:
      - spring-cloud-network

  cloud-nginx:
    container_name: cloud-nginx
    image: nginx
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./nginx/html/dist:/home/cloud/projects/frontend
      - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/logs:/var/log/nginx
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - cloud-gateway
    networks:
      - spring-cloud-network

  cloud-ldap:
    container_name: cloud-ldap
    image: osixia/openldap:latest  # 使用最新版本
    environment:
      LDAP_ORGANISATION: "Example Inc."
      LDAP_DOMAIN: "example.com"
      LDAP_ADMIN_PASSWORD: "Adm!nP@ss2024"  # 强密码
      LDAP_CONFIG_PASSWORD: "C0nf!gP@ss2024"  # 强密码
      LDAP_ADDITIONAL_SCHEMAS: "cosine,inetorgperson,nis"
      # 预配置用户及独立密码
      LDAP_USERS: "user_1,editor_1,admin_1"
      LDAP_PASSWORDS: "User1Pass,Editor1Pass,Admin1Pass"
    ports:
      - "389:389"  # 明文端口（建议仅测试用）
      # - "636:636"  # 需配置 TLS 后启用
    volumes:
      - ./ldap/ldap_data:/var/lib/ldap
      - ./ldap/ldap_config:/etc/ldap/slapd.d
    networks:
      - spring-cloud-network
  cloud-ldap-admin:
    container_name: cloud-ldap-admin
    image: osixia/phpldapadmin:latest
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "cloud-ldap"
      PHPLDAPADMIN_HTTPS: "false"  # 如果不需要HTTPS可以设为false
    ports:
      - "8080:80"  # 将容器的80端口映射到主机的8080端口
    depends_on:
      - cloud-ldap
    networks:
      - spring-cloud-network

  cloud-auth:
    container_name: cloud-auth
    build:
      context: cloud/auth
      dockerfile: Dockerfile
    ports:
      - "9001:9001"
    depends_on:
      - cloud-mysql
      - cloud-ldap
      - cloud-eureka
    environment:
      SERVER_PORT: 9001
      SPRING_PROFILES_ACTIVE: dev
      MYSQL_URL: jdbc:mysql://cloud-mysql:3306/auth_db
      MYSQL_USER: auth_user
      MYSQL_PASSWORD: Adm!nP@ss2024
      LDAP_URL: ldap://ldap
      LDAP_USER_DN_PATTERN: uid={0},ou=people,dc=cloud,dc=com
      SPRING_CLOUD_DISCOVERY_CLIENT_SIMPLE_INSTANCES_INTERVIEW-EUREKA_0_HOST: cloud-eureka
      SPRING_CLOUD_DISCOVERY_CLIENT_SIMPLE_INSTANCES_INTERVIEW-EUREKA_0_PORT: "8761"
      SPRING_CLOUD_DISCOVERY_ENABLED: "true"
      SPRING_CLOUD_EUREKA_USE_DNS: "true"
      SPRING_CLOUD_EUREKA_INSTANCE_INFO_REPLICATOR_ENABLED: "true"
    networks:
      - spring-cloud-network

  cloud-product:
    container_name: cloud-product
    build:
      context: ./cloud/product
      dockerfile: Dockerfile
    ports:
      - "9002:9002"
    depends_on:
      cloud-mysql:
        condition: service_healthy
      cloud-eureka:
        condition: service_started
    environment:
      SERVER_PORT: 9002
      SPRING_PROFILES_ACTIVE: dev
      MYSQL_URL: jdbc:mysql://cloud-mysql:3306/product_db
      MYSQL_USER: product_user
      MYSQL_PASSWORD: Adm!nP@ss2024
      LDAP_URL: ldap://ldap
      LDAP_USER_DN_PATTERN: uid={0},ou=people,dc=cloud,dc=com
      SPRING_CLOUD_DISCOVERY_CLIENT_SIMPLE_INSTANCES_INTERVIEW-EUREKA_0_HOST: cloud-eureka
      SPRING_CLOUD_DISCOVERY_CLIENT_SIMPLE_INSTANCES_INTERVIEW-EUREKA_0_PORT: "8761"
      SPRING_CLOUD_DISCOVERY_ENABLED: "true"
      SPRING_CLOUD_EUREKA_USE_DNS: "true"
      SPRING_CLOUD_EUREKA_INSTANCE_INFO_REPLICATOR_ENABLED: "true"
    networks:
      - spring-cloud-network

  cloud-gateway:
    container_name: cloud-gateway
    build:
      context: ./cloud/gateway
      dockerfile: Dockerfile
    ports:
      - "7573:7573"
    depends_on:
      - cloud-eureka
    environment:
      SERVER_PORT: 7573
      SPRING_CLOUD_DISCOVERY_CLIENT_SIMPLE_INSTANCES_INTERVIEW-EUREKA_0_HOST: cloud-eureka
      SPRING_CLOUD_DISCOVERY_CLIENT_SIMPLE_INSTANCES_INTERVIEW-EUREKA_0_PORT: "8761"
      SPRING_CLOUD_DISCOVERY_ENABLED: "true"
      SPRING_CLOUD_EUREKA_USE_DNS: "true"
      SPRING_CLOUD_EUREKA_INSTANCE_INFO_REPLICATOR_ENABLED: "true"
    networks:
      - spring-cloud-network

networks:
  spring-cloud-network:
    driver: bridge